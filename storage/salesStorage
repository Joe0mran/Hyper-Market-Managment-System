
import java.io.*;
import java.time.LocalDate;
import java.util.*;

public class SalesStorage {

    private Map<Integer, Product> products = new HashMap<>();
    private Map<Integer, Order> orders = new HashMap<>();
    private int orderCounter = 1;

 private final String PRODUCTS_FILE = "data\products.txt"; 
 private final String ORDERS_FILE = "data\order.txt";
    public SalesStorage() {
        loadProducts();
        loadOrders();
    }

    private void loadProducts() {
        products.clear();
        try (BufferedReader br = new BufferedReader(new FileReader(PRODUCTS_FILE))) {
            String line;
            while ((line = br.readLine()) != null) {
                if (line.trim().isEmpty()) continue;

                String[] p = line.split(";");
                if (p.length != 6) continue;

                int id = Integer.parseInt(p[0].trim());
                String name = p[1].trim();
                int quantity = Integer.parseInt(p[2].trim());
                double price = Double.parseDouble(p[3].trim());
                String category = p[4].trim();
                LocalDate expiry = LocalDate.parse(p[5].trim());

                Product product =
                        new Product(id, name, quantity, price, category, expiry);
                products.put(id, product);
            }
        } catch (IOException e) {
            System.out.println("Error loading products file");
        }
    }

    private void saveProducts() {
        try (PrintWriter pw = new PrintWriter(new FileWriter(PRODUCTS_FILE))) {
            for (Product p : products.values()) {
                pw.println(p.toString());
            }
        } catch (IOException e) {
            System.out.println("Error saving products file");
        }
    }

    public Collection<Product> getAllProducts() {
        return products.values();
    }

    public Product searchProduct(int id) {
        return products.get(id);
    }

    

    private void loadOrders() {
        try (BufferedReader br = new BufferedReader(new FileReader(ORDERS_FILE))) {
            String line;
            while ((line = br.readLine()) != null) {
                if (line.trim().isEmpty()) continue;

                String[] parts = line.split("\\|");
                int id = Integer.parseInt(parts[0]);
                Order order = new Order(id);
                order.setStatus(parts[2]);
                orders.put(id, order);
                orderCounter++;
            }
        } catch (IOException ignored) {}
    }

    private void saveOrder(Order o) {
        try (BufferedWriter bw = new BufferedWriter(new FileWriter(ORDERS_FILE, true))) {

            StringBuilder sb = new StringBuilder();
            sb.append(o.getOrderId()).append("|")
              .append(o.getOrderDate()).append("|")
              .append(o.getStatus()).append("|");

            for (orderitem item : o.getItems()) {
                sb.append(item.getProduct().getId())
                  .append(":")
                  .append(item.getQuantity())
                  .append(",");
            }

            if (sb.charAt(sb.length() - 1) == ',')
                sb.deleteCharAt(sb.length() - 1);

            bw.write(sb.toString());
            bw.newLine();

        } catch (IOException e) {
            System.out.println("Error saving order");
        }
    }


    public int createOrder(Map<Integer, Integer> items) {

        Order order = new Order(orderCounter);

        for (Map.Entry<Integer, Integer> e : items.entrySet()) {
            Product p = products.get(e.getKey());

            if (p == null)
                throw new RuntimeException("Product not found");

            if (p.getQuantity() < e.getValue())
                throw new RuntimeException("Not enough stock");

            p.setQuantity(p.getQuantity() - e.getValue());
            order.addItem(new orderitem(p, e.getValue()));
        }

        orders.put(orderCounter, order);
        saveProducts();
        saveOrder(order);

        return orderCounter++;
    }

    public void cancelOrder(int orderId) {

        Order o = orders.get(orderId);
        if (o == null || o.getStatus().equals("Cancelled")) return;

        for (orderitem item : o.getItems()) {
            Product p = item.getProduct();
            p.setQuantity(p.getQuantity() + item.getQuantity());
        }

        o.setStatus("Cancelled");
        saveProducts();
    }

    public Collection<Order> getAllOrders() {
        return orders.values();
    }
}
